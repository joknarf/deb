name: Update DEB Repo

permissions:
  contents: write  # allow push
  pages: write         # for deploy-pages
  id-token: write      # REQUIRED for deploy-pages@v4

on:
  push:
    branches:
      - main
    paths:
      - 'pool/main/*.deb'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        persist-credentials: true

    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev gzip

    - name: Generate Packages metadata for all architectures
      run: |
        for ARCH in amd64 arm64; do
          dpkg-scanpackages --multiversion pool/ /dev/null > dists/stable/main/binary-$ARCH/Packages
          gzip -kf dists/stable/main/binary-$ARCH/Packages
        done

    - name: Generate Release file
      run: |
        cd dists/stable
        apt-ftparchive -c apt-ftparchive.conf release . > Release

    - name: Generate dark-mode index.html with build date
      run: |
        echo "<html><head><title>Joknarf Tools DEB Repository</title><style>
        :root { color-scheme: light dark; }
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
               'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
               margin: 2rem; background: #ffffff; color: #111111; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f5f5f5; text-align: left; }
        a { color: #0969da; text-decoration: none; }
        a:hover { text-decoration: underline; }
        @media (prefers-color-scheme: dark) {
          body { background: #0d1117; color: #c9d1d9; }
          table, th, td { border-color: #30363d; }
          th { background-color: #161b22; }
          a { color: #58a6ff; }
        }
        </style></head><body>" > index.html

        echo "<h1>Joknarf Tools DEB Repository</h1>" >> index.html
        echo "<table>" >> index.html
        echo "<tr><th>Package</th><th>Version</th><th>Arch</th><th>Build Date</th><th>Summary</th><th>Size</th></tr>" >> index.html

        for f in pool/main/*.deb; do
            name="${f##*/}"
            version=$(dpkg-deb -f "$f" Version)
            arch=$(dpkg-deb -f "$f" Architecture)
            desc=$(dpkg-deb -f "$f" Description)
            size=$(du -h "$f" | cut -f1)
            build_epoch=$(dpkg-deb -f "$f" Build-Date 2>/dev/null || echo "")
            build_date=$( [ -n "$build_epoch" ] && date -d "@$build_epoch" "+%Y-%m-%d %H:%M:%S" || echo "unknown" )

            echo "<tr>
              <td><a href=\"$f\">$name</a></td>
              <td>$version</td>
              <td>$arch</td>
              <td>$build_date</td>
              <td>$desc</td>
              <td>$size</td>
            </tr>" >> index.html
        done

        echo "</table></body></html>" >> index.html

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git diff --quiet && git diff --staged --quiet || \
          git commit -m "Update DEB repo and index.html"
        git push

    - uses: actions/configure-pages@v5
    - uses: actions/upload-pages-artifact@v3
      with:
        path: .
    - uses: actions/deploy-pages@v4
